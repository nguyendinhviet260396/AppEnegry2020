{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport { deepMix, has } from '@antv/util';\nimport * as EventParser from './event';\nimport ViewLayer from '../../base/view-layer';\nimport { extractScale } from '../../util/scale';\nimport { getComponent } from '../../components/factory';\nimport { getGeom } from '../../geoms/factory';\nimport { registerPlotType } from '../../base/global';\nimport BulletRect from './component/bulletRect';\nimport BulletTarget from './component/bulletTarget';\nimport './theme';\nvar G2_GEOM_MAP = {\n  bullet: 'interval'\n};\nvar PLOT_GEOM_MAP = {\n  interval: 'bullet'\n};\nexport var STACK_FIELD = '$$stackField$$';\nexport var X_FIELD = '$$xField$$';\nexport var Y_FIELD = '$$yField$$';\n\nvar BulletLayer =\n/** @class */\nfunction (_super) {\n  __extends(BulletLayer, _super);\n\n  function BulletLayer() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.type = 'bullet';\n    return _this;\n  }\n\n  BulletLayer.getDefaultOptions = function () {\n    return deepMix({}, _super.getDefaultOptions.call(this), {\n      data: [],\n      stackField: STACK_FIELD,\n      xField: X_FIELD,\n      yField: Y_FIELD,\n      rangeColors: ['rgba(91, 143, 249, 0.45)'],\n      measureSize: 12,\n      rangeSize: 2,\n      markerSize: 2,\n      markerColors: [],\n      markerStyle: {\n        width: 2,\n        fill: '#5B8FF9',\n        lineWidth: 0\n      },\n      axis: {\n        visible: false,\n        position: 'before',\n        tickCount: 6,\n        formatter: function (text, idx) {\n          return \"\" + idx;\n        },\n        style: {\n          fill: 'rgba(0, 0, 0, 0.25)',\n          textBaseline: 'middle',\n          textAlign: 'center',\n          fontSize: 12,\n          lineHeight: 16\n        },\n        tickLine: {\n          visible: true,\n          lineWidth: 1,\n          stroke: '#FFF',\n          lineDash: [4, 2]\n        }\n      },\n      xAxis: {\n        visible: true,\n        line: {\n          visible: false\n        },\n        tickLine: {\n          visible: false\n        },\n        label: {\n          visible: true\n        }\n      },\n      yAxis: {\n        visible: false,\n        nice: false\n      },\n      tooltip: {\n        visible: false,\n        trigger: 'item',\n        crosshairs: false\n      },\n      label: {\n        visible: true,\n        offset: 4,\n        style: {\n          fill: 'rgba(0, 0, 0, 0.45)',\n          stroke: '#fff',\n          lineWidth: 1\n        }\n      }\n    });\n  };\n\n  BulletLayer.prototype.afterRender = function () {\n    _super.prototype.afterRender.call(this);\n\n    this.view.removeInteraction('legend-filter');\n  };\n\n  BulletLayer.prototype.scale = function () {\n    var options = this.options;\n    var scales = {};\n    /** 配置y-scale */\n\n    scales[options.yField] = {};\n\n    if (has(options, 'yAxis')) {\n      extractScale(scales[options.yField], options.yAxis);\n    }\n    /** 配置x-scale */\n\n\n    scales[options.xField] = {\n      type: 'cat'\n    };\n\n    if (has(options, 'xAxis')) {\n      extractScale(scales[options.xField], options.xAxis);\n    }\n\n    this.setConfig('scales', scales);\n\n    _super.prototype.scale.call(this);\n  };\n\n  BulletLayer.prototype.getOptions = function (props) {\n    var options = _super.prototype.getOptions.call(this, props);\n\n    this.adjustOptions(options);\n    return options;\n  };\n\n  BulletLayer.prototype.afterInit = function () {\n    _super.prototype.afterInit.call(this);\n\n    var options = this.options;\n    var ranges = options.data.map(function (d) {\n      return d.ranges;\n    });\n    var targets = options.data.map(function (d) {\n      return d.targets;\n    });\n    this.bulletRect = new BulletRect(this.view, {\n      ranges: ranges,\n      rangeMax: options.rangeMax,\n      yField: options.yField,\n      rangeSize: options.rangeSize,\n      rangeColors: options.rangeColors || [],\n      axis: options.axis\n    });\n    this.bulletTarget = new BulletTarget(this.view, {\n      targets: targets,\n      yField: options.yField,\n      markerSize: options.markerSize,\n      markerColors: options.markerColors || [],\n      markerStyle: options.markerStyle\n    });\n  };\n\n  BulletLayer.prototype.geometryParser = function (dim, type) {\n    if (dim === 'g2') {\n      return G2_GEOM_MAP[type];\n    }\n\n    return PLOT_GEOM_MAP[type];\n  };\n\n  BulletLayer.prototype.coord = function () {\n    this.setConfig('coordinate', {\n      actions: [['transpose']]\n    });\n  };\n  /** 自定义子弹图图例 */\n\n\n  BulletLayer.prototype.legend = function () {\n    var options = this.options;\n    var markerColor = options.markerStyle.fill;\n    var measureColors = options.measureColors || this.theme.colors;\n    var items = [{\n      name: '实际进度',\n      value: '实际进度',\n      marker: {\n        symbol: 'square',\n        style: {\n          fill: measureColors[0]\n        }\n      }\n    }, {\n      name: '目标值',\n      value: '目标值',\n      marker: {\n        symbol: 'line',\n        style: {\n          stroke: markerColor,\n          lineWidth: 2\n        }\n      }\n    }];\n\n    var legendOptions = __assign({\n      custom: true,\n      position: 'bottom',\n      items: items\n    }, options.legend); // @ts-ignore\n\n\n    this.setConfig('legends', legendOptions);\n  };\n\n  BulletLayer.prototype.addGeometry = function () {\n    var options = this.options;\n    var bullet = getGeom('interval', 'main', {\n      positionFields: [options.xField, options.yField],\n      plot: this\n    });\n    bullet.adjust = [{\n      type: 'stack'\n    }];\n\n    if (options.label) {\n      bullet.label = this.extractLabel();\n    }\n\n    this.bullet = bullet;\n    this.setConfig('geometry', bullet);\n  };\n\n  BulletLayer.prototype.parseEvents = function () {\n    _super.prototype.parseEvents.call(this, EventParser);\n  };\n\n  BulletLayer.prototype.extractLabel = function () {\n    var options = this.options;\n    var label = deepMix({}, options.label);\n\n    if (label.visible === false) {\n      return false;\n    }\n\n    var labelConfig = getComponent('label', __assign({\n      plot: this,\n      labelType: 'barLabel',\n      fields: [options.yField]\n    }, label));\n    return labelConfig;\n  };\n\n  BulletLayer.prototype.adjustOptions = function (options) {\n    options.barSize = options.measureSize || 12;\n    this.adjustYAxisOptions(options);\n  };\n\n  BulletLayer.prototype.adjustYAxisOptions = function (options) {\n    var values = [];\n    options.data.forEach(function (d) {\n      return values.push(d.measures.reduce(function (a, b) {\n        return a + b;\n      }, 0));\n    });\n    values.push(options.rangeMax);\n    options.yAxis.max = Math.max.apply([], values);\n  };\n\n  BulletLayer.prototype.processData = function (dataOptions) {\n    var options = this.options;\n    var data = [];\n    dataOptions.forEach(function (dataItem, dataIdx) {\n      var _a;\n\n      for (var valueIdx = 0; valueIdx < dataItem.measures.length; valueIdx += 1) {\n        var value = dataItem.measures[valueIdx];\n        var xField = dataItem.title || \"\" + dataIdx;\n        data.push((_a = {}, _a[options.xField] = xField, _a[options.yField] = value, _a[options.stackField] = \"\" + valueIdx, _a));\n      }\n    });\n    return data;\n  };\n\n  return BulletLayer;\n}(ViewLayer);\n\nexport default BulletLayer;\nregisterPlotType('bullet', BulletLayer);","map":{"version":3,"sources":["../../../src/plots/bullet/layer.ts"],"names":[],"mappings":"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","sourcesContent":["import { deepMix, has } from '@antv/util';\nimport * as EventParser from './event';\nimport ViewLayer, { ViewConfig } from '../../base/view-layer';\nimport { extractScale } from '../../util/scale';\nimport { getComponent } from '../../components/factory';\nimport { getGeom } from '../../geoms/factory';\nimport { LayerConfig } from '../../base/layer';\nimport { registerPlotType } from '../../base/global';\nimport BulletRect from './component/bulletRect';\nimport BulletTarget from './component/bulletTarget';\nimport { TextStyle, LineStyle } from '../../interface/config';\nimport './theme';\n\nconst G2_GEOM_MAP = {\n  bullet: 'interval',\n};\n\nconst PLOT_GEOM_MAP = {\n  interval: 'bullet',\n};\n\nexport const STACK_FIELD = '$$stackField$$';\nexport const X_FIELD = '$$xField$$';\nexport const Y_FIELD = '$$yField$$';\n\ninterface BulletAxisTickLine extends LineStyle {\n  visible?: boolean;\n}\n\nexport interface BulletAxis {\n  visible: boolean;\n  position?: 'before' | 'after';\n  style?: TextStyle;\n  tickCount?: number;\n  tickLine?: BulletAxisTickLine;\n  formatter?: (text: string, idx: number) => string;\n}\n\nexport interface BulletViewConfig extends ViewConfig {\n  data: {\n    /** 子弹图标题 */\n    title?: string;\n    /** 进度值，array类型。支持阶段性的进度值（即堆叠） */\n    measures: number[];\n    /** 进度条的色条范围区间，相对数值：[0, 1] */\n    ranges?: number[];\n    /** 目标值，array类型。支持多目标设置 */\n    targets: number[];\n  }[];\n  /** 进度条的色条范围区间的最大值 */\n  rangeMax: number;\n  /** 实际进度条大小设置 */\n  measureSize?: number;\n  measureColors?: string[];\n  /** 区间背景条大小设置。ratio number, relative to measureSize */\n  rangeSize?: number;\n  /** 进度条背景颜色 */\n  rangeColors?: string[];\n  /** 目标值 marker 大小设置。ratio number, relative to measureSize */\n  markerSize?: number;\n  /** marker 的填充色 */\n  markerColors?: string[];\n  markerStyle?: {\n    /** marker 的宽度，default: 1 */\n    width?: number;\n    /** marker 的填充色, 若存在 markerColors, 优先取 markerColors */\n    fill?: string;\n    [k: string]: any;\n  };\n  /** 进度条刻度轴设置 */\n  axis?: BulletAxis;\n  stackField?: string;\n}\n\nexport interface BulletLayerConfig extends BulletViewConfig, LayerConfig {}\n\nexport default abstract class BulletLayer extends ViewLayer<BulletViewConfig> {\n  public bullet;\n  protected bulletRect;\n  protected bulletTarget;\n  public type: string = 'bullet';\n  public static getDefaultOptions(): Partial<BulletViewConfig> {\n    return deepMix({}, super.getDefaultOptions(), {\n      data: [],\n      stackField: STACK_FIELD,\n      xField: X_FIELD,\n      yField: Y_FIELD,\n      rangeColors: ['rgba(91, 143, 249, 0.45)'],\n      measureSize: 12,\n      rangeSize: 2,\n      markerSize: 2,\n      markerColors: [],\n      markerStyle: {\n        width: 2,\n        fill: '#5B8FF9',\n        lineWidth: 0,\n      },\n      axis: {\n        visible: false,\n        position: 'before',\n        tickCount: 6,\n        formatter: (text, idx) => `${idx}`,\n        style: {\n          fill: 'rgba(0, 0, 0, 0.25)',\n          textBaseline: 'middle',\n          textAlign: 'center',\n          fontSize: 12,\n          lineHeight: 16,\n        },\n        tickLine: {\n          visible: true,\n          lineWidth: 1,\n          stroke: '#FFF',\n          lineDash: [4, 2],\n        },\n      },\n      xAxis: {\n        visible: true,\n        line: {\n          visible: false,\n        },\n        tickLine: {\n          visible: false,\n        },\n        label: {\n          visible: true,\n        },\n      },\n      yAxis: {\n        visible: false,\n        nice: false,\n      },\n      tooltip: {\n        visible: false,\n        trigger: 'item',\n        crosshairs: false,\n      },\n      label: {\n        visible: true,\n        offset: 4,\n        style: {\n          fill: 'rgba(0, 0, 0, 0.45)',\n          stroke: '#fff',\n          lineWidth: 1,\n        },\n      },\n    });\n  }\n\n  public afterRender() {\n    super.afterRender();\n    this.view.removeInteraction('legend-filter');\n  }\n\n  protected scale() {\n    const options = this.options;\n    const scales = {};\n    /** 配置y-scale */\n    scales[options.yField] = {};\n    if (has(options, 'yAxis')) {\n      extractScale(scales[options.yField], options.yAxis);\n    }\n    /** 配置x-scale */\n    scales[options.xField] = {\n      type: 'cat',\n    };\n    if (has(options, 'xAxis')) {\n      extractScale(scales[options.xField], options.xAxis);\n    }\n    this.setConfig('scales', scales);\n    super.scale();\n  }\n\n  public getOptions(props: BulletViewConfig) {\n    const options = super.getOptions(props);\n    this.adjustOptions(options);\n    return options;\n  }\n\n  public afterInit() {\n    super.afterInit();\n    const options = this.options;\n    const ranges = options.data.map((d) => d.ranges);\n    const targets = options.data.map((d) => d.targets);\n    this.bulletRect = new BulletRect(this.view, {\n      ranges,\n      rangeMax: options.rangeMax,\n      yField: options.yField,\n      rangeSize: options.rangeSize,\n      rangeColors: options.rangeColors || [],\n      axis: options.axis,\n    });\n    this.bulletTarget = new BulletTarget(this.view, {\n      targets,\n      yField: options.yField,\n      markerSize: options.markerSize,\n      markerColors: options.markerColors || [],\n      markerStyle: options.markerStyle,\n    });\n  }\n\n  protected geometryParser(dim, type) {\n    if (dim === 'g2') {\n      return G2_GEOM_MAP[type];\n    }\n    return PLOT_GEOM_MAP[type];\n  }\n\n  protected coord() {\n    this.setConfig('coordinate', {\n      actions: [['transpose']],\n    });\n  }\n\n  /** 自定义子弹图图例 */\n  protected legend() {\n    const options = this.options;\n    const markerColor = options.markerStyle.fill;\n    const measureColors = options.measureColors || this.theme.colors;\n    const items = [\n      {\n        name: '实际进度', // 图例项的文本内容\n        value: '实际进度',\n        marker: {\n          symbol: 'square', // 该图例项 marker 的形状，参见 marker 参数的说明\n          style: {\n            fill: measureColors[0], // 该图例项 marker 的填充颜色\n          },\n        },\n      },\n      {\n        name: '目标值', // 图例项的文本内容\n        value: '目标值',\n        marker: {\n          symbol: 'line', // 该图例项 marker 的形状，参见 marker 参数的说明\n          style: {\n            stroke: markerColor, // 该图例项 marker 的填充颜色\n            lineWidth: 2, // 该图例项 marker 的填充颜色\n          },\n        },\n      },\n    ];\n    const legendOptions = {\n      custom: true,\n      position: 'bottom',\n      items,\n      ...options.legend,\n    };\n    // @ts-ignore\n    this.setConfig('legends', legendOptions);\n  }\n\n  protected addGeometry() {\n    const options = this.options;\n    const bullet = getGeom('interval', 'main', {\n      positionFields: [options.xField, options.yField],\n      plot: this,\n    });\n    bullet.adjust = [\n      {\n        type: 'stack',\n      },\n    ];\n    if (options.label) {\n      bullet.label = this.extractLabel();\n    }\n    this.bullet = bullet;\n    this.setConfig('geometry', bullet);\n  }\n\n  protected parseEvents() {\n    super.parseEvents(EventParser);\n  }\n\n  protected extractLabel() {\n    const options = this.options;\n    const label = deepMix({}, options.label);\n    if (label.visible === false) {\n      return false;\n    }\n    const labelConfig = getComponent('label', {\n      plot: this,\n      labelType: 'barLabel',\n      fields: [options.yField],\n      ...label,\n    });\n    return labelConfig;\n  }\n\n  protected adjustOptions(options): void {\n    options.barSize = options.measureSize || 12;\n    this.adjustYAxisOptions(options);\n  }\n\n  protected adjustYAxisOptions(options): void {\n    const values = [];\n    options.data.forEach((d) => values.push(d.measures.reduce((a, b) => a + b, 0)));\n    values.push(options.rangeMax);\n    options.yAxis.max = Math.max.apply([], values);\n  }\n\n  protected processData(dataOptions: BulletViewConfig['data']) {\n    const options = this.options;\n    const data = [];\n    dataOptions.forEach((dataItem, dataIdx) => {\n      for (let valueIdx = 0; valueIdx < dataItem.measures.length; valueIdx += 1) {\n        const value = dataItem.measures[valueIdx];\n        const xField = dataItem.title || `${dataIdx}`;\n        data.push({\n          [options.xField]: xField,\n          [options.yField]: value,\n          [options.stackField]: `${valueIdx}`,\n        });\n      }\n    });\n    return data;\n  }\n}\n\nregisterPlotType('bullet', BulletLayer);\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}