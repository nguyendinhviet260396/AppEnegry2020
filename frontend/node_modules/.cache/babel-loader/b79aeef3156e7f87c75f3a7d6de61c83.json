{"ast":null,"code":"import { each, deepMix, clone, find } from '@antv/util';\nimport { rgb2arr } from '../../../util/color';\nimport BBox from '../../../util/bbox';\nvar DEFAULT_OFFSET = 8;\n\nfunction mappingColor(band, gray) {\n  var reflect;\n  each(band, function (b) {\n    var map = b;\n\n    if (gray >= map.from && gray < map.to) {\n      reflect = map.color;\n    }\n  });\n  return reflect;\n}\n\nvar RangeBarLabel =\n/** @class */\nfunction () {\n  function RangeBarLabel(cfg) {\n    this.destroyed = false;\n    this.view = cfg.view;\n    this.plot = cfg.plot;\n    var defaultOptions = this.getDefaultOptions();\n    this.options = deepMix(defaultOptions, cfg, {});\n\n    if (!this.options.leftStyle) {\n      this.options.leftStyle = this.options.style;\n    }\n\n    if (!this.options.rightStyle) {\n      this.options.rightStyle = this.options.style;\n    }\n\n    this.init();\n  }\n\n  RangeBarLabel.prototype.init = function () {\n    var _this = this;\n\n    this.container = this.getGeometry().labelsContainer;\n    this.view.on('beforerender', function () {\n      _this.clear();\n\n      _this.plot.canvas.draw();\n    });\n  };\n\n  RangeBarLabel.prototype.render = function () {\n    var _this = this;\n\n    var _a = this.getGeometry(),\n        elements = _a.elements,\n        coordinate = _a.coordinate;\n\n    this.coord = coordinate;\n    each(elements, function (ele) {\n      var shape = ele.shape;\n\n      var positions = _this.getPosition(shape);\n\n      var values = _this.getValue(shape);\n\n      var textAlign = _this.getTextAlign();\n\n      var labels = [];\n      each(positions, function (pos, i) {\n        var style = i === 0 ? _this.options.leftStyle : _this.options.rightStyle;\n\n        var color = _this.getTextColor(shape, i);\n\n        if (_this.options.position === 'inner' && _this.options.adjustColor && color !== 'black') {\n          style.stroke = null;\n        }\n\n        var formatter = _this.options.formatter;\n        var content = formatter ? formatter(values[i]) : values[i];\n\n        var label = _this.container.addShape('text', {\n          attrs: deepMix({}, style, {\n            x: pos.x,\n            y: pos.y,\n            text: content,\n            fill: color,\n            textAlign: textAlign[i],\n            textBaseline: 'middle'\n          }),\n          name: 'label'\n        });\n\n        labels.push(label);\n\n        _this.doAnimation(label);\n      });\n      shape.set('labelShapes', labels);\n\n      _this.adjustPosition(labels[0], labels[1], shape);\n    });\n    this.plot.canvas.draw();\n  };\n\n  RangeBarLabel.prototype.hide = function () {\n    this.container.set('visible', false);\n    this.plot.canvas.draw();\n  };\n\n  RangeBarLabel.prototype.show = function () {\n    this.container.set('visible', true);\n    this.plot.canvas.draw();\n  };\n\n  RangeBarLabel.prototype.clear = function () {\n    if (this.container) {\n      this.container.clear();\n    }\n  };\n\n  RangeBarLabel.prototype.destroy = function () {\n    if (this.container) {\n      this.container.remove();\n    }\n\n    this.destroyed = true;\n  };\n\n  RangeBarLabel.prototype.getBBox = function () {\n    return this.container.getBBox();\n  };\n\n  RangeBarLabel.prototype.getShapeBbox = function (shape) {\n    var _this = this;\n\n    var points = [];\n    each(shape.get('origin').points, function (p) {\n      points.push(_this.coord.convertPoint(p));\n    });\n    var bbox = new BBox(points[0].x, points[1].y, Math.abs(points[2].x - points[0].x), Math.abs(points[0].y - points[1].y));\n    return bbox;\n  };\n\n  RangeBarLabel.prototype.getDefaultOptions = function () {\n    var theme = this.plot.theme;\n    var labelStyle = theme.label.style;\n    return {\n      position: 'outer',\n      offsetX: DEFAULT_OFFSET,\n      offsetY: 0,\n      style: clone(labelStyle),\n      adjustColor: true,\n      adjustPosition: true\n    };\n  };\n\n  RangeBarLabel.prototype.getPosition = function (shape) {\n    var bbox = this.getShapeBbox(shape);\n    var minX = bbox.minX,\n        maxX = bbox.maxX,\n        minY = bbox.minY,\n        height = bbox.height;\n    var _a = this.options,\n        offsetX = _a.offsetX,\n        offsetY = _a.offsetY;\n    var y = minY + height / 2 + offsetY;\n    var x1, x2;\n\n    if (this.options.position === 'outer') {\n      x1 = minX - offsetX;\n      x2 = maxX + offsetX;\n    } else {\n      x1 = minX + offsetX;\n      x2 = maxX - offsetX;\n    }\n\n    return [{\n      x: x1,\n      y: y\n    }, {\n      x: x2,\n      y: y\n    }];\n  };\n\n  RangeBarLabel.prototype.getValue = function (shape) {\n    var xField = this.plot.options.xField;\n    return shape.get('origin').data[xField];\n  };\n\n  RangeBarLabel.prototype.getTextAlign = function () {\n    if (this.options.position === 'outer') {\n      return ['right', 'left'];\n    } else {\n      return ['left', 'right'];\n    }\n  };\n\n  RangeBarLabel.prototype.getTextColor = function (shape, index) {\n    if (this.options.adjustColor && this.options.position === 'inner') {\n      var shapeColor = shape.attr('fill');\n      var shapeOpacity = shape.attr('opacity') ? shape.attr('opacity') : 1;\n      var rgb = rgb2arr(shapeColor);\n      var gray = Math.round(rgb[0] * 0.299 + rgb[1] * 0.587 + rgb[2] * 0.114) / shapeOpacity;\n      var colorBand = [{\n        from: 0,\n        to: 85,\n        color: 'white'\n      }, {\n        from: 85,\n        to: 170,\n        color: '#F6F6F6'\n      }, {\n        from: 170,\n        to: 255,\n        color: 'black'\n      }];\n      var reflect = mappingColor(colorBand, gray);\n      return reflect;\n    }\n\n    var defaultColor = index === 0 ? this.options.leftStyle.fill : this.options.rightStyle.fill;\n    return defaultColor;\n  };\n\n  RangeBarLabel.prototype.doAnimation = function (label) {\n    if (this.plot.animation && this.plot.animation === false) {\n      return;\n    }\n\n    label.attr('fillOpacity', 0);\n    label.attr('strokeOpacity', 0);\n    label.stopAnimate();\n    label.animate({\n      fillOpacity: 1,\n      strokeOpacity: 1\n    }, 800, 'easeLinear', 500);\n  };\n\n  RangeBarLabel.prototype.adjustPosition = function (la, lb, shape) {\n    var origin = shape.get('origin');\n    var shapeMinX = origin.x[0];\n    var shapeMaxX = origin.x[1];\n    var shapeWidth = Math.abs(shapeMaxX - shapeMinX);\n    var panelRange = this.view.coordinateBBox;\n    var boxes = [la.getBBox(), lb.getBBox()];\n    var ax = la.attr('x');\n    var bx = lb.attr('x');\n\n    if (this.options.adjustPosition && this.options.position === 'inner') {\n      var totalLength = boxes[0].width + boxes[1].width;\n      var isOverlap = boxes[0].maxX - boxes[1].minX > 2;\n      var isTooShort = totalLength > shapeWidth;\n\n      if (isOverlap || isTooShort) {\n        ax = shapeMinX - this.options.offsetX;\n        la.attr('fill', this.options.leftStyle.fill);\n        la.attr('textAlign', 'right');\n        boxes[0] = la.getBBox();\n        bx = shapeMaxX + this.options.offsetX;\n        lb.attr('fill', this.options.rightStyle.fill);\n        lb.attr('textAlign', 'left');\n        boxes[1] = lb.getBBox();\n      }\n    }\n\n    if (boxes[0].minX < panelRange.minX) {\n      ax = panelRange.minX + DEFAULT_OFFSET;\n      la.attr('textAlign', 'left');\n    }\n\n    la.attr('x', ax);\n    lb.attr('x', bx);\n    this.plot.canvas.draw();\n  };\n\n  RangeBarLabel.prototype.getGeometry = function () {\n    return find(this.view.geometries, function (geom) {\n      return geom.type === 'interval';\n    });\n  };\n\n  return RangeBarLabel;\n}();\n\nexport default RangeBarLabel;","map":{"version":3,"sources":["../../../../src/plots/range-bar/component/label.ts"],"names":[],"mappings":"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","sourcesContent":["import { each, deepMix, clone, find } from '@antv/util';\nimport { View, IGroup, Geometry } from '../../../dependents';\nimport { rgb2arr } from '../../../util/color';\nimport BBox from '../../../util/bbox';\n\nconst DEFAULT_OFFSET = 8;\n\nfunction mappingColor(band, gray) {\n  let reflect;\n  each(band, (b) => {\n    const map = b;\n    if (gray >= map.from && gray < map.to) {\n      reflect = map.color;\n    }\n  });\n  return reflect;\n}\n\nexport interface RangeBarLabelConfig {\n  visible: boolean;\n  position?: 'outer' | 'inner';\n  formatter?: (...args: any[]) => string;\n  offsetX?: number;\n  offsetY?: number;\n  style?: any;\n  leftStyle?: any;\n  rightStyle?: any;\n  adjustColor?: boolean;\n  adjustPosition?: boolean;\n}\n\nexport interface IRangeBarLabel extends RangeBarLabelConfig {\n  view: View;\n  plot: any;\n}\n\nexport default class RangeBarLabel {\n  public options: RangeBarLabelConfig;\n  public destroyed: boolean = false;\n  private plot: any;\n  private view: View;\n  private coord: any;\n  private container: IGroup;\n\n  constructor(cfg: IRangeBarLabel) {\n    this.view = cfg.view;\n    this.plot = cfg.plot;\n    const defaultOptions = this.getDefaultOptions();\n    this.options = deepMix(defaultOptions, cfg, {});\n    if (!this.options.leftStyle) {\n      this.options.leftStyle = this.options.style;\n    }\n    if (!this.options.rightStyle) {\n      this.options.rightStyle = this.options.style;\n    }\n    this.init();\n  }\n\n  public init() {\n    this.container = this.getGeometry().labelsContainer;\n    this.view.on('beforerender', () => {\n      this.clear();\n      this.plot.canvas.draw();\n    });\n  }\n\n  public render() {\n    const { elements, coordinate } = this.getGeometry();\n    this.coord = coordinate;\n    each(elements, (ele) => {\n      const { shape } = ele;\n      const positions = this.getPosition(shape);\n      const values = this.getValue(shape);\n      const textAlign = this.getTextAlign();\n      const labels = [];\n      each(positions, (pos, i) => {\n        const style = i === 0 ? this.options.leftStyle : this.options.rightStyle;\n        const color = this.getTextColor(shape, i);\n        if (this.options.position === 'inner' && this.options.adjustColor && color !== 'black') {\n          style.stroke = null;\n        }\n        const formatter = this.options.formatter;\n        const content = formatter ? formatter(values[i]) : values[i];\n        const label = this.container.addShape('text', {\n          attrs: deepMix({}, style, {\n            x: pos.x,\n            y: pos.y,\n            text: content,\n            fill: color,\n            textAlign: textAlign[i],\n            textBaseline: 'middle',\n          }),\n          name: 'label',\n        });\n        labels.push(label);\n        this.doAnimation(label);\n      });\n      shape.set('labelShapes', labels);\n      this.adjustPosition(labels[0], labels[1], shape);\n    });\n    this.plot.canvas.draw();\n  }\n\n  public hide() {\n    this.container.set('visible', false);\n    this.plot.canvas.draw();\n  }\n\n  public show() {\n    this.container.set('visible', true);\n    this.plot.canvas.draw();\n  }\n\n  public clear() {\n    if (this.container) {\n      this.container.clear();\n    }\n  }\n\n  public destroy() {\n    if (this.container) {\n      this.container.remove();\n    }\n    this.destroyed = true;\n  }\n\n  public getBBox() {\n    return this.container.getBBox();\n  }\n\n  protected getShapeBbox(shape) {\n    const points = [];\n    each(shape.get('origin').points, (p) => {\n      points.push(this.coord.convertPoint(p));\n    });\n    const bbox = new BBox(\n      points[0].x,\n      points[1].y,\n      Math.abs(points[2].x - points[0].x),\n      Math.abs(points[0].y - points[1].y)\n    );\n    return bbox;\n  }\n\n  private getDefaultOptions() {\n    const { theme } = this.plot;\n    const labelStyle = theme.label.style;\n    return {\n      position: 'outer',\n      offsetX: DEFAULT_OFFSET,\n      offsetY: 0,\n      style: clone(labelStyle),\n      adjustColor: true,\n      adjustPosition: true,\n    };\n  }\n\n  private getPosition(shape) {\n    const bbox = this.getShapeBbox(shape);\n    const { minX, maxX, minY, height } = bbox;\n    const { offsetX, offsetY } = this.options;\n    const y = minY + height / 2 + offsetY;\n    let x1, x2;\n    if (this.options.position === 'outer') {\n      x1 = minX - offsetX;\n      x2 = maxX + offsetX;\n    } else {\n      x1 = minX + offsetX;\n      x2 = maxX - offsetX;\n    }\n    return [\n      { x: x1, y },\n      { x: x2, y },\n    ];\n  }\n\n  private getValue(shape) {\n    const { xField } = this.plot.options;\n    return shape.get('origin').data[xField];\n  }\n\n  private getTextAlign() {\n    if (this.options.position === 'outer') {\n      return ['right', 'left'];\n    } else {\n      return ['left', 'right'];\n    }\n  }\n\n  private getTextColor(shape, index) {\n    if (this.options.adjustColor && this.options.position === 'inner') {\n      const shapeColor = shape.attr('fill');\n      const shapeOpacity = shape.attr('opacity') ? shape.attr('opacity') : 1;\n      const rgb = rgb2arr(shapeColor);\n      const gray = Math.round(rgb[0] * 0.299 + rgb[1] * 0.587 + rgb[2] * 0.114) / shapeOpacity;\n      const colorBand = [\n        { from: 0, to: 85, color: 'white' },\n        { from: 85, to: 170, color: '#F6F6F6' },\n        { from: 170, to: 255, color: 'black' },\n      ];\n      const reflect = mappingColor(colorBand, gray);\n      return reflect;\n    }\n    const defaultColor = index === 0 ? this.options.leftStyle.fill : this.options.rightStyle.fill;\n    return defaultColor;\n  }\n\n  private doAnimation(label) {\n    if (this.plot.animation && this.plot.animation === false) {\n      return;\n    }\n    label.attr('fillOpacity', 0);\n    label.attr('strokeOpacity', 0);\n    label.stopAnimate();\n    label.animate(\n      {\n        fillOpacity: 1,\n        strokeOpacity: 1,\n      },\n      800,\n      'easeLinear',\n      500\n    );\n  }\n\n  private adjustPosition(la, lb, shape) {\n    const origin = shape.get('origin');\n    const shapeMinX = origin.x[0];\n    const shapeMaxX = origin.x[1];\n    const shapeWidth = Math.abs(shapeMaxX - shapeMinX);\n    const panelRange = this.view.coordinateBBox;\n    const boxes = [la.getBBox(), lb.getBBox()];\n    let ax = la.attr('x');\n    let bx = lb.attr('x');\n    if (this.options.adjustPosition && this.options.position === 'inner') {\n      const totalLength = boxes[0].width + boxes[1].width;\n      const isOverlap = boxes[0].maxX - boxes[1].minX > 2;\n      const isTooShort = totalLength > shapeWidth;\n      if (isOverlap || isTooShort) {\n        ax = shapeMinX - this.options.offsetX;\n        la.attr('fill', this.options.leftStyle.fill);\n        la.attr('textAlign', 'right');\n        boxes[0] = la.getBBox();\n        bx = shapeMaxX + this.options.offsetX;\n        lb.attr('fill', this.options.rightStyle.fill);\n        lb.attr('textAlign', 'left');\n        boxes[1] = lb.getBBox();\n      }\n    }\n    if (boxes[0].minX < panelRange.minX) {\n      ax = panelRange.minX + DEFAULT_OFFSET;\n      la.attr('textAlign', 'left');\n    }\n    la.attr('x', ax);\n    lb.attr('x', bx);\n    this.plot.canvas.draw();\n  }\n\n  private getGeometry() {\n    return find(this.view.geometries, (geom) => geom.type === 'interval') as Geometry;\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}